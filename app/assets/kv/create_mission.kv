<CreateMissionScreen>:
    name: "create_mission"

    canvas.before:
        Color:
            rgba: 0.05, 0.1, 0.2, 1
        Rectangle:
            pos: self.pos
            size: self.size

    MDBoxLayout:
        orientation: "vertical"

        MDTopAppBar:
            title: "Cr√©er une mission"
            left_action_items: [["arrow-left", lambda x: root.go_back()]]
            right_action_items: [["logout", lambda x: app.logout()]]
            elevation: 4
            md_bg_color: 0.05, 0.1, 0.2, 1
            specific_text_color: 1, 1, 1, 1
            height: dp(48)
            size_hint_y: None

        ScrollView:
            MDBoxLayout:
                orientation: "vertical"
                padding: dp(20)
                spacing: dp(15)
                size_hint_y: None
                height: self.minimum_height

                # ===== SECTION INFOS MISSION =====
                MDLabel:
                    text: "Informations mission"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    font_style: "H6"
                    bold: True

                MDTextField:
                    id: date_field
                    hint_text: "Date"
                    mode: "rectangle"
                    on_focus: if self.focus: root.show_date_picker()
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: client
                    hint_text: "Client"
                    mode: "rectangle"
                    on_text: root.autocomplete_client(self.text)
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: client_telephone
                    hint_text: "T√©l√©phone du client"
                    mode: "rectangle"
                    text: "+212"
                    helper_text: "Doit commencer par +212 et contenir 9 chiffres"
                    helper_text_mode: "on_focus"
                    on_text:
                        if not self.text.startswith("+212"): self.text = "+212"
                        elif len(self.text) > 13: self.text = self.text[:13]
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: drone_field
                    hint_text: "Choisir drone (DJI T40 ou T50)"
                    mode: "rectangle"
                    readonly: True
                    on_focus: if self.focus: root.open_drone_menu()
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: taux_field
                    hint_text: "Taux d'application (L/ha)"
                    mode: "rectangle"
                    input_filter: "int"
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: superficie
                    hint_text: "Superficie (ha)"
                    mode: "rectangle"
                    input_filter: "float"
                    on_text: root.calculer_prix_total()
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: prix_unitaire
                    hint_text: "Prix unitaire (DH/ha)"
                    mode: "rectangle"
                    input_filter: "float"
                    on_text: root.calculer_prix_total()
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDLabel:
                    id: prix_total_label
                    text: "Prix total : 0.00 DH"
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    bold: True

                # ===== SECTION LOCALISATION =====
                MDLabel:
                    text: "Localisation"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    font_style: "H6"
                    bold: True

                MDTextField:
                    id: province
                    hint_text: "Province"
                    mode: "rectangle"
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: commune
                    hint_text: "Commune"
                    mode: "rectangle"
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: commentaire
                    hint_text: "Coordonn√©es lieu (format DD.dddd,DD.dddd)"
                    mode: "rectangle"
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDRectangleFlatButton:
                    text: "üìç Ouvrir carte"
                    on_release: root.open_map_popup()

                # ===== SECTION TELEPILOTE =====
                MDLabel:
                    text: "T√©l√©pilote"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    font_style: "H6"
                    bold: True

                MDTextField:
                    id: telepilote_field
                    hint_text: "S√©lectionner t√©l√©pilote"
                    mode: "rectangle"
                    readonly: True
                    on_focus: if self.focus: root.open_telepilote_menu()
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

                MDTextField:
                    id: telepilote_telephone
                    hint_text: "T√©l√©phone du t√©l√©pilote"
                    mode: "rectangle"
                    readonly: True
                    theme_text_color: "Custom"
                    text_color_normal: 1, 1, 1, 1
                    text_color_focus: 1, 1, 1, 1
                    hint_text_color_normal: 0.8, 0.8, 0.8, 1
                    line_color_normal: 0.6, 0.6, 0.6, 1
                    line_color_focus: 1, 1, 1, 1

        MDBoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: dp(20)
            spacing: dp(10)
            md_bg_color: 0.05, 0.1, 0.2, 1

            Widget:

            MDRaisedButton:
                text: "Cr√©er la mission"
                on_release: root.create_mission()
                md_bg_color: 0.2, 0.6, 1, 1
                text_color: 1, 1, 1, 1
